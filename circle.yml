machine:

  services:
    - docker
  environment:
    COUCHDB_NAME: ccitest

dependencies:
  override:
    - sudo pip install --upgrade docker-compose
    - npm install
    - ./node_modules/.bin/gulp build --production
    - docker-compose build
    - docker-compose pull

test:
  override:
    - docker-compose --no-color up db
    - docker-compose --no-color up app:
        environment:
          COUCHDB_PUBLIC_URL: http://localhost
          COUCHDB_PUBLIC_PORT: ${$(docker-compose port db 5984)#*:}
    - npm test:
        environment:
          MOCHA_DOCKER: true
          APP_PUBLIC_URL: http://localhost:3000
          APP_PUBLIC_PORT: ${$(docker-compose port app 3000)#*:}
          COUCHDB_PUBLIC_URL: http://localhost
          COUCHDB_PUBLIC_PORT: ${$(docker-compose port db 5984)#*:}
